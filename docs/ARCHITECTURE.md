# LinkC Platform 系统架构

> 版本: 2.0 | 更新日期: 2026-01-22
> 变更: 新增演示增强层 (Demo Layer)，更新进度至MVP完成

---

## 1. 架构概述

### 1.1 系统定位

LinkC是基于**ECIS（企业群体智能系统）**架构的物业机器人协同平台，通过AI Agent实现多品牌机器人的智能调度和协同工作。

### 1.2 核心架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              LinkC Platform                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         前端层 (Frontend)                            │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │   │
│  │  │ 战略驾驶舱 │ │ 运营控制台 │ │ 训练工作台 │ │  移动端   │           │   │
│  │  │ E1-E3 ✅  │ │ O1-O4 ✅  │ │ T1-T4 ✅  │ │ P1-P3 ✅  │           │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │ HTTP/WebSocket                        │
│                                    ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        API网关层 (API Gateway)                       │   │
│  │  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐  │   │
│  │  │ G1  │ │ G2  │ │ G3  │ │ G4  │ │ G5  │ │ G6  │ │ G7  │ │Demo │  │   │
│  │  │认证 │ │空间 │ │任务 │ │机器人│ │Agent│ │数据 │ │管理 │ │ API │  │   │
│  │  │ ✅  │ │ ✅  │ │ ✅  │ │ ✅  │ │ ✅  │ │ ✅  │ │ ✅  │ │ 🆕  │  │   │
│  │  └─────┘ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      演示增强层 (Demo Layer) 🆕                      │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │   │
│  │  │ DM1 数据  │ │ DM2 模拟  │ │ DM3 控制  │ │ DM4 对话  │           │   │
│  │  │  服务     │ │  引擎     │ │  面板     │ │  增强     │           │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Agent层 (Agents)                             │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │              A1: Agent 运行时框架 ✅                          │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐                        │   │
│  │  │ A2 清洁   │  │ A3 对话   │  │ A4 数据   │                        │   │
│  │  │ 调度 ✅   │  │ 助手 ✅   │  │ 采集 ✅   │                        │   │
│  │  └───────────┘  └───────────┘  └───────────┘                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │ MCP Protocol                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       MCP服务层 (MCP Servers)                        │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐        │   │
│  │  │ M1 空间   │  │ M2 任务   │  │ M3 高仙   │  │ M4 控制   │        │   │
│  │  │ 管理 ✅   │  │ 管理 ✅   │  │ 机器人 ✅ │  │ 通用 ✅   │        │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       数据平台层 (Data Platform)                     │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐                        │   │
│  │  │ D1 采集   │  │ D2 存储   │  │ D3 查询   │                        │   │
│  │  │ 引擎 ✅   │  │ 服务 ✅   │  │ API ✅    │                        │   │
│  │  └───────────┘  └───────────┘  └───────────┘                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        数据层 (Data Layer)                           │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐                        │   │
│  │  │PostgreSQL │  │  Redis    │  │TimescaleDB│                        │   │
│  │  │ 主数据库  │  │   缓存    │  │ 时序数据  │                        │   │
│  │  └───────────┘  └───────────┘  └───────────┘                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       外部集成 (External)                            │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐        │   │
│  │  │ 高仙API   │  │ 科沃斯API │  │  PMS系统  │  │ SSO/OAuth │        │   │
│  │  │ (模拟)    │  │ (待实现)  │  │ (待对接)  │  │ (待对接)  │        │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

图例: ✅ 已完成  🆕 新增模块  (模拟) 使用模拟实现  (待对接) 需生产环境对接
```

---

## 2. 分层架构详解

### 2.1 Layer 0: 基础设施层 (100% ✅)

| 模块 | 职责 | 技术选型 | 状态 |
|-----|------|---------|------|
| F1: 数据模型 | 定义所有共享数据结构 | Pydantic v2 | ✅ |
| F2: 共享工具 | 通用工具函数 | Python标准库 | ✅ |
| F3: 配置管理 | 环境配置、多租户配置 | pydantic-settings | ✅ |
| F4: 认证授权 | JWT认证、RBAC权限 | python-jose, passlib | ✅ |

### 2.2 Layer 1: MCP服务层 (100% ✅)

| 模块 | 职责 | Tools数量 | 测试数 | 状态 |
|-----|------|----------|--------|------|
| M1: 空间管理 | 管理楼宇、楼层、区域 | 8 | 18 | ✅ |
| M2: 任务管理 | 管理清洁任务和排程 | 10 | 21 | ✅ |
| M3: 高仙机器人 | 对接高仙机器人API | 12 | 28 | ✅ (模拟) |
| M4: 机器人控制 | 通用机器人控制 | 6 | 8 | ✅ |

### 2.3 Layer 2: 数据平台层 (100% ✅)

| 模块 | 职责 | 测试数 | 状态 |
|-----|------|--------|------|
| D1: 数据采集 | 定时/事件驱动的数据采集 | 15 | ✅ |
| D2: 数据存储 | 数据持久化和索引 | 22 | ✅ |
| D3: 数据查询 | 提供数据查询接口 | 19 | ✅ |

### 2.4 Layer 3: Agent层 (100% ✅)

| 模块 | 职责 | 自主性级别 | 测试数 | 状态 |
|-----|------|-----------|--------|------|
| A1: 运行时框架 | Agent生命周期管理 | - | 23 | ✅ |
| A2: 清洁调度 | 清洁任务智能调度 | L2 | 14 | ✅ |
| A3: 对话助手 | 自然语言交互 | L0 | 11 | ✅ |
| A4: 数据采集 | 定时采集机器人状态 | L3 | 14 | ✅ |

### 2.5 Layer 4: API网关层 (100% ✅)

| 模块 | 路由前缀 | 测试数 | 状态 |
|-----|---------|--------|------|
| G1: 认证API | /api/v1/auth | 24 | ✅ |
| G2: 空间API | /api/v1/spaces | 27 | ✅ |
| G3: 任务API | /api/v1/tasks | 24 | ✅ |
| G4: 机器人API | /api/v1/robots | 34 | ✅ |
| G5: Agent交互 | /api/v1/agents | 33 | ✅ |
| G6: 数据API | /api/v1/data | 25 | ✅ |
| G7: 管理API | /api/v1/admin | 29 | ✅ |

### 2.6 Layer 5: 前端层 (100% ✅)

| 终端 | 模块 | 用户角色 | 状态 |
|-----|------|---------|------|
| 战略驾驶舱 | E1-E3 | 高管 | ✅ |
| 运营控制台 | O1-O4 | 运营经理 | ✅ |
| 训练工作台 | T1-T4 | 训练师 | ✅ |
| 移动端 | P1-P3 | 现场人员 | ✅ |

### 2.7 Layer 6: 演示增强层 (新增) 🆕

> 详细规格见: `docs/specs/demo/DEMO_ENHANCEMENT_SPEC.md`

| 模块 | 名称 | 职责 | 状态 |
|-----|------|------|------|
| DM1 | 演示数据服务 | 管理演示数据加载、重置、场景切换 | 待开发 |
| DM2 | 实时模拟引擎 | 模拟机器人实时移动、状态变化 | 待开发 |
| DM3 | 演示控制面板 | 提供演示控制界面 | 待开发 |
| DM4 | Agent对话增强 | 预设精彩对话场景 | 待开发 |
| DM5 | 地图动态可视化 | 增强机器人地图展示效果 | 待开发 |

**演示增强层架构**:

```
┌─────────────────────────────────────────────────────────────────┐
│                      演示增强层 (Demo Layer)                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    DM3: 演示控制面板                      │   │
│  │  [场景切换] [事件触发] [速度控制] [重置]                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                     │
│           ┌───────────────┼───────────────┐                     │
│           ▼               ▼               ▼                     │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │
│  │ DM1: 数据   │ │ DM2: 模拟   │ │ DM4: 对话   │               │
│  │   服务      │ │   引擎      │ │   增强      │               │
│  │             │ │             │ │             │               │
│  │ - 种子数据  │ │ - 位置更新  │ │ - 预设场景  │               │
│  │ - 场景配置  │ │ - 状态变化  │ │ - 推理展示  │               │
│  │ - 数据重置  │ │ - WebSocket │ │ - 学习演示  │               │
│  └─────────────┘ └─────────────┘ └─────────────┘               │
│           │               │               │                     │
│           └───────────────┼───────────────┘                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  DM5: 地图动态可视化                       │   │
│  │  - 机器人移动动画  - 清洁轨迹  - 状态颜色  - 交互效果     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 人机协同交互模式

### 3.1 三层用户界面设计

```
┌─────────────────────────────────────────────────────────────────┐
│                     人机协同交互层次                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Level 3: 战略层 (Executive)                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  用户: 高管 / 投资人                                      │   │
│  │  关注: 业务价值、ROI、战略决策                            │   │
│  │  交互: 查看KPI、趋势分析、报表导出                        │   │
│  │  AI辅助: 异常预警、优化建议、预测分析                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                     │
│  Level 2: 运营层 (Operations)                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  用户: 运营经理 / 调度员                                  │   │
│  │  关注: 实时状态、任务调度、告警处理                       │   │
│  │  交互: 派发任务、处理告警、调整策略                       │   │
│  │  AI辅助: 智能调度、资源优化、问题诊断                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                     │
│  Level 1: 训练层 (Training)                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  用户: 训练师 / 技术专家                                  │   │
│  │  关注: Agent行为、决策质量、学习优化                      │   │
│  │  交互: 审批决策、提供反馈、调整参数                       │   │
│  │  AI辅助: 决策解释、学习曲线、性能分析                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           │                                     │
│  Level 0: 执行层 (Execution)                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  执行者: AI Agent + 机器人                                │   │
│  │  行为: 自主执行任务、汇报状态、请求帮助                   │   │
│  │  人类介入: 审批高风险决策、处理异常、提供指导             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 Agent自主性级别

| 级别 | 名称 | 行为模式 | 人类介入 | 示例 |
|------|------|----------|----------|------|
| L0 | 被动响应 | 只响应人类请求 | 每次操作 | 对话助手 |
| L1 | 建议执行 | 提出建议，人类确认 | 确认执行 | 任务推荐 |
| L2 | 有限自主 | 预设边界内自主 | 异常时介入 | 清洁调度 |
| L3 | 完全自主 | 自主决策和执行 | 定期审查 | 数据采集 |

---

## 4. 数据流架构

### 4.1 实时数据流

```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│   机器人     │─────▶│  MCP Server │─────▶│   Agent     │
│  (模拟/真实) │ API  │  M3/M4      │ MCP  │  A2/A4      │
└─────────────┘      └─────────────┘      └─────────────┘
                                                │
                                                ▼
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│   前端UI    │◀─────│  API网关    │◀─────│  数据平台   │
│  WebSocket  │ WS   │  G1-G7      │ SQL  │  D1-D3      │
└─────────────┘      └─────────────┘      └─────────────┘
```

### 4.2 命令下发流

```
用户操作 → API网关 → Agent决策 → MCP调用 → 机器人执行
    │          │          │          │          │
    │          │          │          │          ▼
    │          │          │          │     状态更新
    │          │          │          │          │
    │          │          │          ◀──────────┘
    │          │          ◀────── 执行结果
    │          ◀────── 处理结果
    ◀────── UI更新
```

---

## 5. 部署架构

### 5.1 容器化部署

```
┌─────────────────────────────────────────────────────────────────┐
│                        Docker Compose                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │   Nginx     │  │  Frontend   │  │   Backend   │             │
│  │  (反向代理)  │  │  (React)    │  │  (FastAPI)  │             │
│  │  Port: 80   │  │  Port: 5173 │  │  Port: 8000 │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ PostgreSQL  │  │    Redis    │  │  MCP Servers │             │
│  │  Port: 5432 │  │  Port: 6379 │  │  Port: 800x │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ Prometheus  │  │   Grafana   │  │    Loki     │             │
│  │  监控采集   │  │   可视化    │  │   日志聚合   │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 生产环境建议

详见: `docs/DEPLOYMENT.md`

---

## 6. 模拟与真实系统对接

> 详见: `docs/INTEGRATION_REQUIREMENTS.md`

### 6.1 当前模拟实现

| 组件 | 模拟方式 | 生产对接 |
|------|----------|----------|
| 高仙机器人 | MockGaoxianClient | 高仙云平台API |
| 用户认证 | 模拟用户数据 | OAuth2/SSO |
| 空间数据 | 内存示例数据 | PMS系统 |
| 推送通知 | 控制台日志 | FCM/APNs |

### 6.2 对接优先级

- **P0**: 高仙机器人真实API (上线必须)
- **P1**: 认证系统、科沃斯机器人 (上线后1月内)
- **P2**: PMS系统、推送通知 (上线后3月内)

---

## 7. 技术栈总览

### 7.1 后端

| 组件 | 技术 | 版本 |
|------|------|------|
| 语言 | Python | 3.11+ |
| Web框架 | FastAPI | 0.100+ |
| MCP SDK | mcp | 0.9+ |
| ORM | SQLAlchemy | 2.0 (async) |
| 验证 | Pydantic | v2 |
| LLM | 火山引擎豆包 | doubao-pro-32k |

### 7.2 前端

| 组件 | 技术 | 版本 |
|------|------|------|
| 框架 | React | 18 |
| 语言 | TypeScript | 5.x |
| 构建 | Vite | 5.x |
| 样式 | TailwindCSS | 3.4 |
| 路由 | React Router | 6.x |

### 7.3 数据库

| 组件 | 用途 |
|------|------|
| PostgreSQL | 主数据库 |
| TimescaleDB | 时序数据扩展 |
| Redis | 缓存、消息队列 |

### 7.4 基础设施

| 组件 | 用途 |
|------|------|
| Docker | 容器化 |
| Docker Compose | 编排 |
| Nginx | 反向代理 |
| Prometheus | 监控 |
| Grafana | 可视化 |
| Loki | 日志 |

---

## 8. 附录

### 8.1 相关文档

| 文档 | 路径 |
|------|------|
| 开发进度 | `docs/PROGRESS.md` |
| 部署指南 | `docs/DEPLOYMENT.md` |
| 集成需求 | `docs/INTEGRATION_REQUIREMENTS.md` |
| 演示增强规格 | `docs/specs/demo/DEMO_ENHANCEMENT_SPEC.md` |
| 问题知识库 | `docs/LESSONS_LEARNED.md` |

### 8.2 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| 1.0 | 2026-01-19 | 初始架构设计 |
| 2.0 | 2026-01-22 | MVP完成，新增演示增强层 |

---

*文档版本: 2.0*
*最后更新: 2026-01-22*
