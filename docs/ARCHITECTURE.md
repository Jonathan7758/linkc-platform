# LinkC Platform 系统架构

> 版本: 1.0 | 更新日期: 2026-01-19

---

## 1. 架构概述

### 1.1 系统定位

LinkC是基于**ECIS（企业群体智能系统）**架构的物业机器人协同平台，通过AI Agent实现多品牌机器人的智能调度和协同工作。

### 1.2 核心架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              LinkC Platform                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         前端层 (Frontend)                            │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │   │
│  │  │ 训练工作台   │  │ 运营控制台   │  │ 战略驾驶舱   │                  │   │
│  │  │ (Trainer)   │  │ (Operations)│  │ (Executive) │                  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │ HTTP/WebSocket                        │
│                                    ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        API网关层 (API Gateway)                       │   │
│  │  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐          │   │
│  │  │空间 │ │任务 │ │机器人│ │监控 │ │Agent│ │报表 │ │用户 │          │   │
│  │  │API │ │API │ │API  │ │API │ │API │ │API │ │API │          │   │
│  │  └─────┘ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                       │
│                                    ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Agent层 (Agents)                             │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │                    Agent 运行时框架                          │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │   │
│  │  │ 清洁调度     │  │ 对话助手     │  │ 数据采集     │                  │   │
│  │  │ Agent      │  │ Agent      │  │ Agent      │                  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │ MCP Protocol                          │
│                                    ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       MCP服务层 (MCP Servers)                        │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │   │
│  │  │ 空间管理     │  │ 任务管理     │  │ 机器人控制   │                  │   │
│  │  │ MCP Server │  │ MCP Server │  │ MCP Server │                  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                       │
│                                    ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        数据层 (Data Layer)                           │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │   │
│  │  │ PostgreSQL  │  │   Redis    │  │ TimescaleDB │                  │   │
│  │  │ (主数据库)   │  │  (缓存)     │  │ (时序数据)   │                  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       外部集成 (External)                            │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │   │
│  │  │ 高仙机器人   │  │ 科沃斯机器人 │  │  其他设备   │                  │   │
│  │  │   API      │  │   API      │  │   API      │                  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 分层架构详解

### 2.1 Layer 0: 基础设施层

| 模块 | 职责 | 技术选型 |
|-----|------|---------|
| F1: 数据模型 | 定义所有共享数据结构 | Pydantic v2 |
| F2: 共享工具 | 通用工具函数 | Python标准库 |
| F3: 配置管理 | 环境配置、多租户配置 | pydantic-settings |
| F4: 认证授权 | JWT认证、RBAC权限 | python-jose, passlib |

### 2.2 Layer 1: MCP服务层

MCP (Model Context Protocol) 是Agent与外部系统交互的标准协议。

| 模块 | 职责 | 提供的Tools |
|-----|------|------------|
| M1: 空间管理 | 管理楼宇、楼层、区域 | list_buildings, get_zone, ... |
| M2: 任务管理 | 管理清洁任务和排程 | create_task, update_task, ... |
| M3: 高仙机器人 | 对接高仙机器人API | get_status, start_cleaning, ... |
| M4: 科沃斯机器人 | 对接科沃斯机器人API | get_status, start_cleaning, ... |

### 2.3 Layer 2: 数据平台层

| 模块 | 职责 | 实现 |
|-----|------|------|
| D1: 数据采集 | 定时/事件驱动的数据采集 | APScheduler + 事件监听 |
| D2: 数据存储 | 数据持久化和索引 | PostgreSQL + TimescaleDB |
| D3: 数据查询 | 提供数据查询接口 | FastAPI + SQLAlchemy |

### 2.4 Layer 3: Agent层

| 模块 | 职责 | 自主性级别 |
|-----|------|-----------|
| A1: 运行时框架 | Agent生命周期管理 | - |
| A2: 清洁调度 | 清洁任务智能调度 | L2 (有限自主) |
| A3: 对话助手 | 自然语言交互 | L0 (被动响应) |
| A4: 数据采集 | 定时采集机器人状态 | L3 (完全自主) |

**Agent自主性级别定义**:
- L0: 被动响应 - 只响应人类请求
- L1: 建议执行 - 提出建议，人类确认后执行
- L2: 有限自主 - 在预设边界内自主执行
- L3: 完全自主 - 自主决策和执行

### 2.5 Layer 4: API网关层

| 模块 | 路由前缀 | 职责 |
|-----|---------|------|
| G1: 空间API | /api/v1/spaces | 空间数据CRUD |
| G2: 任务API | /api/v1/tasks | 任务数据CRUD |
| G3: 机器人API | /api/v1/robots | 机器人状态和控制 |
| G4: 监控API | /api/v1/monitoring | Agent活动流、异常事件 |
| G5: Agent交互 | /api/v1/agent | Agent对话、命令 |
| G6: 报表API | /api/v1/reports | 统计报表数据 |
| G7: 用户API | /api/v1/users | 用户认证、权限 |

### 2.6 Layer 5: 前端层

| 终端 | 用户角色 | 核心功能 |
|-----|---------|---------|
| 训练工作台 | 训练师 | Agent监控、反馈、干预 |
| 运营控制台 | 运营经理 | KPI、效率分析、策略配置 |
| 战略驾驶舱 | 高管 | 总览、决策支持、报告 |

---

## 3. 数据流架构

### 3.1 实时数据流

```
机器人 ──► MCP Server ──► Agent ──► WebSocket ──► 前端
   │           │            │
   │           ▼            ▼
   │        Redis        决策日志
   │        (缓存)       (PostgreSQL)
   │
   ▼
TimescaleDB
(历史数据)
```

### 3.2 任务执行流

```
┌─────────────────────────────────────────────────────────────────┐
│                         任务执行流程                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 任务创建                                                    │
│     用户/系统 ──► API ──► 任务管理MCP ──► 存储                  │
│                                                                 │
│  2. 任务调度                                                    │
│     清洁调度Agent ◄── 定时触发/事件触发                         │
│           │                                                     │
│           ├── 查询待执行任务（任务管理MCP）                      │
│           ├── 查询机器人状态（机器人MCP）                        │
│           ├── 查询空间信息（空间管理MCP）                        │
│           │                                                     │
│           ▼                                                     │
│     生成调度决策                                                │
│           │                                                     │
│           ├── L2任务: 自动执行                                  │
│           └── L1任务: 等待确认                                  │
│                                                                 │
│  3. 任务执行                                                    │
│     Agent ──► 机器人MCP ──► 机器人API ──► 机器人                │
│                                                                 │
│  4. 状态同步                                                    │
│     机器人 ──► 机器人MCP ──► Agent ──► 更新任务状态             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 部署架构

### 4.1 开发环境

```yaml
# docker-compose.dev.yml
services:
  api:
    build: .
    ports: ["8000:8000"]
    volumes: ["./src:/app/src"]
    
  postgres:
    image: postgres:15
    ports: ["5432:5432"]
    
  redis:
    image: redis:7
    ports: ["6379:6379"]
    
  mcp-space:
    build: ./mcp_servers/space_manager
    
  mcp-task:
    build: ./mcp_servers/task_manager
```

### 4.2 生产环境（规划）

```
┌─────────────────────────────────────────────────────────────────┐
│                        Kubernetes Cluster                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │   Ingress   │  │   Ingress   │  │   Ingress   │             │
│  │  (API)      │  │  (WS)       │  │  (Web)      │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│         │               │               │                       │
│         ▼               ▼               ▼                       │
│  ┌─────────────────────────────────────────────────┐           │
│  │              API Pods (HPA)                      │           │
│  └─────────────────────────────────────────────────┘           │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ Agent Pods  │  │  MCP Pods   │  │ Worker Pods │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│         │               │               │                       │
│         ▼               ▼               ▼                       │
│  ┌─────────────────────────────────────────────────┐           │
│  │           Managed Database Services              │           │
│  │  (PostgreSQL, Redis, TimescaleDB)               │           │
│  └─────────────────────────────────────────────────┘           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 安全架构

### 5.1 认证与授权

```
┌─────────────────────────────────────────────────────────────────┐
│                         安全架构                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  认证流程:                                                      │
│  用户 ──► 登录API ──► 验证凭据 ──► 生成JWT ──► 返回Token        │
│                                                                 │
│  请求授权:                                                      │
│  请求 ──► API Gateway ──► JWT验证 ──► RBAC检查 ──► 业务处理     │
│                                                                 │
│  角色权限:                                                      │
│  ┌─────────────┬─────────────────────────────────────────┐     │
│  │ 角色        │ 权限                                    │     │
│  ├─────────────┼─────────────────────────────────────────┤     │
│  │ trainer     │ Agent监控、反馈、有限干预               │     │
│  │ operations  │ KPI查看、策略配置、审批                 │     │
│  │ executive   │ 全部查看、决策审批                      │     │
│  │ admin       │ 全部权限                               │     │
│  └─────────────┴─────────────────────────────────────────┘     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 多租户隔离

```python
# 所有数据模型包含tenant_id
class Robot(Base):
    id: str
    tenant_id: str  # 租户隔离
    name: str
    ...

# 查询时自动过滤
async def get_robots(tenant_id: str):
    return await session.execute(
        select(Robot).where(Robot.tenant_id == tenant_id)
    )
```

---

## 6. 扩展性设计

### 6.1 新增机器人品牌

1. 创建新的MCP Server: `src/mcp_servers/robot_[brand]/`
2. 实现标准Tool接口（参考 `interfaces/mcp_tools.py`）
3. 注册到Agent运行时
4. 无需修改Agent逻辑

### 6.2 新增Agent类型

1. 继承 `BaseAgent` 类
2. 实现 `decide()` 和 `execute()` 方法
3. 定义自主性级别和升级规则
4. 注册到运行时框架

### 6.3 新增前端终端

1. 创建新的React应用
2. 复用API和组件库
3. 配置权限控制

---

## 7. 监控与可观测性

### 7.1 监控指标

| 类别 | 指标 | 告警阈值 |
|-----|------|---------|
| API | 请求延迟 P99 | > 500ms |
| API | 错误率 | > 1% |
| Agent | 决策延迟 | > 5s |
| Agent | 升级率 | > 20% |
| 机器人 | 在线率 | < 95% |
| 机器人 | 任务完成率 | < 90% |

### 7.2 日志规范

```python
import structlog

logger = structlog.get_logger(__name__)

# 标准日志格式
logger.info(
    "task_assigned",
    task_id=task.id,
    robot_id=robot.id,
    zone_id=zone.id,
    tenant_id=tenant_id
)
```

### 7.3 链路追踪

```python
# 使用OpenTelemetry
from opentelemetry import trace

tracer = trace.get_tracer(__name__)

async def process_task(task_id: str):
    with tracer.start_as_current_span("process_task") as span:
        span.set_attribute("task_id", task_id)
        ...
```

---

## 附录: 技术决策记录

### ADR-001: 选择MCP作为Agent-工具通信协议

**背景**: 需要Agent与各种工具和外部系统交互

**决策**: 采用Anthropic的MCP协议

**理由**:
1. 标准化的Tool定义和调用方式
2. 与Claude生态兼容
3. 支持多种传输方式(stdio, HTTP)

### ADR-002: 选择PostgreSQL作为主数据库

**背景**: 需要可靠的关系型数据库

**决策**: PostgreSQL 15+

**理由**:
1. 成熟稳定
2. 支持JSON类型
3. 丰富的扩展生态(TimescaleDB, PostGIS)

### ADR-003: 三层前端架构

**背景**: 不同角色需要不同的界面和功能

**决策**: 训练工作台 + 运营控制台 + 战略驾驶舱

**理由**:
1. 关注点分离
2. 独立部署和迭代
3. 更好的用户体验
